<template>
	<div
		class="flex flex-col w-full px-5 py-5 overflow-auto bg-field dark:bg-dark-notif pt-20 sm:px-28 sm:ml-64 sm:pt-3 h-screen"
	>
		<div
			class="flex justify-end items-center text-end w-full sm:w-11/12 h-10"
		>
			<router-link
				to="create-itinerary"
				class="flex items-center justify-center rounded-full font-montserrat h-full w-32 text-xl text-center bg-second text-white"
				>+ Create</router-link
			>
		</div>

		<div
			class="cont-itinerary mt-6 pt-4 px-6 items-center align-middle rounded-lg shadow-lg bg-interface dark:bg-dark-interface cursor-pointer sm:w-11/12 sm:px-6"
			v-for="(itinerary, index) in itineraries"
			:key="itinerary.id"
		>
			<div class="mt-2 sm:px-5 sm:pt-5 mb-10 w-full">
				<img
					class="rounded-lg shadow-2xl object-cover drop-shadow-xl w-full h-auto"
					:src="itinerary.main_image"
					alt=""
				/>
				<div class="w-full h-auto py-2">
					<!-- <div class="flex flex-row justify-start items-center"> -->
						<h1
							class="font-bebas-neue text-prime dark:text-interface text-3xl mt-5 sm:text-4xl"
						>
							{{ itinerary.main_title }}
						</h1>
						
					<p
						class="font-montserrat text-sm text-justify h-auto dark:text-interface"
					>
						{{
							isFullTextShown[index]
								? itinerary.main_description
								: itinerary.main_description.length > 100
								? itinerary.main_description.substring(0, 100) +
								  "..."
								: itinerary.main_description
						}}
						<!-- Toggle link -->
						<a
							href="#"
							@click="goToViewItinerary(itinerary.id)"
							class="text-blue-500"
						>
							{{
								isFullTextShown[index] ? "see less" : "see more"
							}}
						</a>
					</p>
				</div>
				<div class="flex items-center mt-5">
					<img
						class="rounded-full w-12 shadow-2xl drop-shadow-xl sm:w-[80px]sm:mb-8"
						:src="itinerary.user_photo"
						alt=""
					/>
					<h1
						class="font-montserrat font-semibold text-prime dark:text-interface ml-2 pr-2 border border-l-0 border-y-0 border-r-prime dark:border-r-interface hover:underline cursor-pointer sm:font-normal sm:text-sm sm:ml-5 sm:pr-5"
					>
						@{{ itinerary.creator_name }}
					</h1>
					<h1
						class="font-montserrat text-xs text-second ml-2 sm:text-sm sm:ml-5"
					>
						{{
							new Date(itinerary.date_posted).toLocaleDateString(
								"en-US",
								{
									month: "long",
									day: "numeric",
									year: "numeric",
								}
							)
						}}
					</h1>
				</div>
			</div>
		</div>

		<div class="mt-10"></div>
	</div>
</template>

<script>
import axios from "axios";
import ViewItinerary from "./ViewItinerary.vue";
export default {
	components: {
		ViewItinerary,
	},
	data() {
		return {
			itineraries: [],
			isFullTextShown: {}, // Initialize as empty object
			rating: 0,
		};
	},
	watch: {
		// Watcher to update isFullTextShown when itineraries changes
		itineraries(newVal) {
			this.isFullTextShown = newVal.reduce((acc, _, index) => {
				acc[index] = false; // Initialize all as false (collapsed)
				return acc;
			}, {});
		},
		rating(newValue, itinerarId) {
			console.log(`Rating changed to: ${newValue}`);
			this.client.post("api/rating", { rate: newValue });
			// Perform an action when the rating changes
		},
	},
	mounted() {
		this.fetchItineraries();
	},
	created() {
		const token = localStorage.getItem("token");
		const headers = {
			Authorization: `Token ${token}`,
			"Content-Type": "application/json",
		};
		this.client = axios.create({
			baseURL: "http://127.0.0.1:8000",
			withCredentials: true,
			timeout: 5000,
			xsrfCookieName: "csrftoken",
			xsrfHeaderName: "X-Csrftoken",
			headers: headers,
		});
		this.fetchItineraries();
	},
	methods: {
		// updateRating(itineraryId, rating) {
		// 	console.log(`Rating changed to: ${rating} for itinerary ${itineraryId}`);
		// 	this.client.post("api/rating", {
		// 		rate: rating,
		// 		itinerary_id: itineraryId,
		// 	}).then(res => {
		// 		console.loh(res);
		// 		// Handle the response here
		// 	}).catch(error => {
		// 		console.error(error);
		// 	});
		// },
	

		goToViewItinerary(itinerarydata) {
			this.$router.push({
				name: "view-itinerary",
				params: { itinerarydata },
			});
		},
		toggleText(index) {
			this.isFullTextShown[index] = !this.isFullTextShown[index];
		},
		async fetchItineraries() {
			try {
				const response = await this.client.get("/api/saved-itinerary");
				this.itineraries = response.data;
				console.log(this.itineraries);
			} catch (error) {
				console.error(error);
			}
		},
	},
};
</script>

<style scoped>
@import url(//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css);

fieldset,




/****** Style Star Rating Widget *****/

.rating {
	border: none;
	float: left;
}

.rating > input {
	display: none;
}
.rating > label:before {
	margin: 5px;
	font-size: 1.25em;
	font-family: FontAwesome;
	display: inline-block;
	content: "\f005";
}

.rating > .half:before {
	content: "\f089";
	position: absolute;
}

.rating > label {
	color: #ddd;
	float: right;
}

/***** CSS Magic to Highlight Stars on Hover *****/

.rating > input:checked ~ label, /* show gold star when clicked */
.rating:not(:checked) > label:hover, /* hover current star */
.rating:not(:checked) > label:hover ~ label {
	color: #ffd700;
} /* hover previous stars in list */

.rating > input:checked + label:hover, /* hover current star when changing rating */
.rating > input:checked ~ label:hover,
.rating > label:hover ~ input:checked ~ label, /* lighten current selection */
.rating > input:checked ~ label:hover ~ label {
	color: #ffed85;
}
</style>
